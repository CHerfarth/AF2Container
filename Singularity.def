Bootstrap: docker
From: nvcr.io/nvidia/pytorch:24.01-py3

%files
    requirements.txt /opt/requirements.txt
    alphafold /opt/alphafold
    predict.py /opt/predict.py
    af2_util.py /opt/af2_util.py
    model_weights /opt/model_weights


%environment
    export PATH=/opt/miniconda/envs/alphafold/bin:$PATH
    export CONDA_PREFIX=/opt/miniconda/envs/alphafold
    export LD_LIBRARY_PATH=/opt/miniconda/envs/alphafold/lib:$LD_LIBRARY_PATH
    export PYTHONNOUSERSITE=1

%post
    echo "[INFO] Updating apt cache"
    apt-get update || true
    apt-get install -y \
        libglib2.0-0 \
        ca-certificates \
        wget \
        git \
        tar \
        bzip2 || true

    echo "[INFO] Installing Miniconda"
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh
    bash /tmp/miniconda.sh -b -p /opt/miniconda
    rm /tmp/miniconda.sh
    export PATH=/opt/miniconda/bin:$PATH

    echo "[INFO] Configuring Conda to avoid defaults"
    conda config --system --set always_yes yes
    conda config --system --remove channels defaults || true
    conda config --system --add channels conda-forge
    conda config --system --add channels nvidia
    conda config --system --add channels bioconda
    conda config --system --add channels https://conda.rosettacommons.org

    echo "[INFO] Creating Conda environment from requirements.txt"
    conda env create -f /opt/requirements.txt -n alphafold python=3.9
    
    conda run -n alphafold pip install --upgrade pip
    conda run -n alphafold pip install silent-tools
    conda run -n alphafold pip install "jax==0.4.20" "jaxlib==0.4.20+cuda12.cudnn89" \
	 -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

    echo "[INFO] Cleaning up"
    conda clean -afy


%runscript
    exec python3 /opt/predict.py "$@"

%labels
    Author Arman Thariani
    Version v1.0
    Description "Minimal Singularity container for AlphaFold using alphafold Conda environment"
